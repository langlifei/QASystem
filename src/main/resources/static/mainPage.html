<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
        <div>
            <form>
                <textarea maxlength="50" id="text"></textarea>
                <button type="button" onclick="sendMessage()">发送</button>
            </form>
        </div>
        <div>
            <ul id = "content">
            </ul>

        </div>
</body>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script>
        var token = localStorage.getItem("token");
        var username ="";
        if(token!=null){
            var data = decodeURIComponent(escape(window.atob(token.split('.')[1])))
            username = JSON.parse(data).username;
        }
        var receiver="-1";
        debugger;
        url ="ws://localhost:8080/websocket/"+username
        //创建一个webSocket实例
        var webSocket = new WebSocket(url);

        webSocket.onopen = function (ev) {
        }

        //监听消息，服务端是否发回消息
        webSocket.onmessage=function (ev) {
            var data = ev.data;
            if(data!="连接成功"){
                data = $.parseJSON(data);
                receiver = data.from;
                $("#content").append("<li>"+data.from+"-"+data.date+"-------------:"+data.text+"</li>");
            }else {
                console.log(data);
            }
        }

        //监听webSocket是否已关闭
        webSocket.onclose=function (ev) {
            console.log("webSocket已关闭。。。");
        }

        webSocket.onerror=function (ev) {
            console.log("websocket发生错误。。。")
        }

        function sendMessage() {
            var text = $("#text").val();
            var data= new Object();
            data.from=username;
            data.to=receiver;
            debugger;
            data.text=text;
            //发送消息
            if(webSocket.readyState==1){
                console.log(JSON.stringify(data));
                webSocket.send(JSON.stringify(data));
                $("#content").append("<li> 我："+data.text+"</li>");
                $("#text").val("");
            }
        }

    </script>
</html>